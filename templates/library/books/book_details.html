{% extends 'base1.html' %}
{% load static %}

{% block additional_css %}
<style>
    .status-active {
        background-color: #198754;
        color: white;
        padding: 0.5rem 1rem;
    }
    .status-overdue {
        background-color: #dc3545;
        color: white;
        padding: 0.5rem 1rem;
    }
    .status-returned {
        background-color: #0d6efd;
        color: white;
        padding: 0.5rem 1rem;
    }
    .loader {
        height: 3px;
        width: 100%;
        display: none;
        background-color: #f3f3f3;
    }
    .loader.active {
        display: block;
        background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
        animation: loading 1s infinite;
    }
    @keyframes loading {
        0% { width: 0; }
        50% { width: 100%; }
        100% { width: 0; }
    }
    .book-cover-placeholder {
        transition: all 0.3s ease;
    }
    .book-cover-placeholder:hover {
        background-color: #e9ecef !important;
    }
    .table-responsive {
        min-height: 400px;
    }
    .book-details-card {
        border: none;
        border-radius: 15px;
        background: white;
        transition: all 0.3s ease;
    }
    .book-details-card:hover {
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .book-info-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .book-info-item:last-child {
        border-bottom: none;
    }
    .book-title {
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
    }
    .records-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }
    .search-container {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 0.5rem;
    }
    .custom-table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        color: #495057;
        font-weight: 600;
    }
    .custom-table td {
        padding: 1rem 0.75rem;
    }
    .action-btn {
        border-radius: 20px;
        padding: 0.4rem 1rem;
        transition: all 0.3s ease;
    }
    .action-btn:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock additional_css %}

{% block content %}
<div class="card book-details-card mb-4 shadow-sm">
    <div class="card-body p-4">
        <div class="row">
                <h3 class="book-title text-center">{{book.title}}</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="book-info-item">
                            <i class="fas fa-user me-2 text-primary"></i>
                            <strong>Author:</strong> 
                            <span class="ms-2">{{book.author}}</span>
                        </div>
                        <div class="book-info-item">
                            <i class="fas fa-bookmark me-2 text-primary"></i>
                            <strong>Category:</strong> 
                            <span class="ms-2">{{book.category}}</span>
                        </div>
                        <div class="book-info-item">
                            <i class="fas fa-barcode me-2 text-primary"></i>
                            <strong>ISBN:</strong> 
                            <span class="ms-2">{{book.isbn}}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="book-info-item">
                            <i class="fas fa-calendar me-2 text-primary"></i>
                            <strong>Published:</strong> 
                            <span class="ms-2">{{book.publication_date}}</span>
                        </div>
                        <div class="book-info-item">
                            <i class="fas fa-book-open me-2 text-primary"></i>
                            <strong>Available:</strong> 
                            <span class="ms-2 badge {% if book.copies_available == 0 %}bg-danger{% elif book.copies_available <= 2 %}bg-warning{% else %}bg-success{% endif %} rounded-pill">
                                {{book.copies_available}} / {{book.total_copies}}
                            </span>
                        </div>
                        <div class="book-info-item">
                            <i class="fas fa-tag me-2 text-primary"></i>
                            <strong>Price:</strong> 
                            <span class="ms-2">${{book.unit_price}}</span>
                        </div>
                    </div>
                </div>
           
        </div>
    </div>
</div>

<div class="card records-card shadow-sm">
    <div class="card-header bg-white py-4">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h5 class="mb-0 text-primary">
                    <i class="fas fa-history me-2"></i>Issuing Records
                </h5>
            </div>
            <div class="col-md-5">
                <div class="search-container">
                    <div class="input-group">
                        <span class="input-group-text border-0 bg-transparent">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-0 bg-transparent" 
                               placeholder="Search records..." id="searchInput" 
                               value="{{ search_query }}">
                    </div>
                </div>
            </div>
            <div class="col-md-3 text-end">
                <button class="btn btn-primary action-btn" 
                        data-bs-toggle="modal" 
                        data-bs-target="#issueBookModal{{book.id}}">
                    <i class="fas fa-plus me-2"></i>Issue to Member
                </button>
            </div>
        </div>
    </div>
    
    {% include "library/books/issue_book.html" %}
    <!-- Loading Bar -->
    <div class="loader" id="loader"></div>

    <!-- Table Container -->
    <div class="table-responsive">
        <table class="table custom-table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Member</th>
                    <th>Borrow Date</th>
                    <th>Due Date</th>
                    <th>Return Date</th>
                    <th>Status</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for borrowing in borrowings %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-light rounded-circle me-2">
                                <i class="fas fa-user text-primary"></i>
                            </div>
                            {{ borrowing.member }}
                        </div>
                    </td>
                    <td><i class="far fa-calendar-alt me-1 text-muted"></i>{{ borrowing.borrow_date }}</td>
                    <td><i class="far fa-calendar-check me-1 text-muted"></i>{{ borrowing.due_date }}</td>
                    <td>
                        {% if borrowing.return_date %}
                            <i class="far fa-calendar-check me-1 text-muted"></i>{{ borrowing.return_date }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge rounded-pill status-{{ borrowing.status|lower }}">
                            {{ borrowing.status }}
                        </span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary action-btn"
                                data-bs-toggle="modal" 
                                data-bs-target="#borrowingDetailsModal{{borrowing.id}}">
                            <i class="fas fa-eye me-1"></i>Details
                        </button>
                    </td>
                </tr>
                {% include "library/borrowing/borrowing_details.html" %}
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="empty-state">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">No borrowing records found</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock content %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const loader = document.getElementById('loader');
        let searchTimeout;

        // Search functionality
        searchInput.addEventListener('keyup', function() {
            clearTimeout(searchTimeout);
            loader.classList.add('active');

            searchTimeout = setTimeout(() => {
                const searchQuery = this.value;
                window.location.href = `?search=${encodeURIComponent(searchQuery)}`;
            }, 500);
        });

        // Utility function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock additional_scripts %}